---
title: "The pbratios package"
author: "Andrea Bazzano"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    fig_caption: true
    df_print: kable
vignette: >
  %\VignetteIndexEntry{The pbratios package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The package `pbratios` contains a set of R functions to efficiently extract, process and visually inspect Pb isotope ratio data from the .csv report generated by the Perkin Elmer ELAN ICP-MS instrument. This package is currently under test.


# Fundamental functions

## Get the raw intensities and ratios by `extract.data`

The function `extract.data` is used to gather the sample names and the intensities measured for each nuclide and present them in a tidy table. The function is compatible with two different types of report: _short_ and _long_.

* _short_ reports have only information about the sample ID, the time at which the     analysis ended, a summary with average intensities and then the intensity values for each replicate. An example of this report is `sednya_2015.csv` and it can be accessible with
```{r}
file.short <- system.file("extdata", "sednya_2015.csv", package = "pbratios")
```
* _long_ reports contain also information about the measurement conditions and the summary section is at the end of the intensity values for each replicates. They are usually produced when working in isotope ratio mode. An example of this report is `spmnya_2012.csv` and it can be accessible with
```{r}
file.long <- system.file("extdata", "spmnya_2012.csv", package = "pbratios")
```

When using the function `extract.data` the first argument is the path for the .csv file, while the second argument `report` need to be equal either to `"short"` or `"long"` depending on the type of file generated by the instrument.

Standard reference material used for standard bracketing must be labelled as "SRM", whereas QC samples as "CRM". The function will append a progressive integer to these names.

The output of the function is a table where each row represent a replicate, whereas columns gather the intensities for each measured nuclides, raw $^{20x}\mathrm{Pb}/^{20y}\mathrm{Pb}$ ratios are also displayed, where $x, y = 6, 7, 8$. 
These Pb isotope ratio still need to be filtered for possible outliers, summarised and corrected for instrumental mass bias.

A typical output is given by
```{r}
library(pbratios)
spmnya <- extract.data(file.long, report = "long")
head(spmnya)
```

## Remove possible outliers and summarise ratios by `calc.ratios`

The output from the function `extract.data` can be inspected for outliers by using the function `calc.ratios`. Possible outliers are defined as those ratios exceeding the $\mathrm{median} \pm 2.5\, \mathrm{mad}$ range and are automatically removed from the dataset. Only about $5\,\%$ of the data is removed.

The dataset is then summarised keeping only average ratios and standard errors for each sample. Additionally, a table with the number of outliers removed for each sample is printed on screen.
```{r, results='hide'}
spmnya.ratios <- calc.ratios(spmnya)
head(spmnya.ratios)
```
```{r, echo=FALSE}
head(spmnya.ratios)
```
These ratios still need to be corrected for mass bias before being interpreted.

## Standard bracketing for mass bias correction using `corr.mbf`

Isotope ratios can be corrected for instrumental mass bias using several approaches. The function `corr.mbf` only implements the standard bracketing.

To use the `corr.mbf` function, standards for bracketing must be labelled as "SRM" and they must be diluted solutions of NIST SRM 981.

The function subset the dataset so that it starts and ends with bracketing standards, any samples before or after the first or last SRM will be ignored.

`corr.mbf` can be used directly on the output of `calc.ratios` and it will return a table containing the corrected $^{20x}\mathrm{Pb}/^{20y}\mathrm{Pb}$ ratios corredated with their extended uncertainties ($U = k\, u\mathrm{,}\  k = 2$).

```{r}
spmnya.corr <- corr.mbf(spmnya.ratios)
knitr::kable(head(spmnya.corr), digits = 4, pad = 0)
```

The three functions presented so far can also be combined conveniently using the _pipe_ operator `%>%` provided by the package `dplyr`:
```{r, eval=FALSE}
library(dplyr)
file.long <- system.file("extdata", "spmnya_2012.csv", package = "pbratios")
spmnya <- file.long %>% 
          extract.data(report = "long") %>% 
          calc.ratios %>% 
          corr.mbf
head(spmnya)
```

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
